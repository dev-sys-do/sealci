# Monitor

## Contributors

- Sarah THEOULLE
- Pauline CONTAT
- Thomas BROINE
- Baptiste BRONSIN

## Features

- Listening to events from a remote Git repository
- Recognizing the event type
- Adapting actions according to the event type and then calling the controller via an external API. It means that when a event is recognized a pipeline is triggered

## What

Based on user provided configuration, the monitor listens for specific events from a remote Git repository and takes actions based on them. We need to recognize two types of events: `Commit` and `Pull Request`. Depending on the event type, an HTTP request will be sent to the controller.

`POST` /pipeline :

**Body**:

- `pipeline_name`: A `string` that corresponds to the pipeline name.
- `body`: A `file` that is generated by the monitor and contains the actions to be executed by the controller.
- `repo_name`: A `string`that corresponds to the watched repo name.

>[!Note]
> The request **will** be a multipart/form-data since the pipeline file could be quite long.

## Why

The goal is to trigger the controller to launch a CI process according to the detected event from the remote repository.

## How

**Set Up the Git Repository:**
In the CLI, you can launch the monitoring while giving the following parameters:

- `--event`: The type of event to listen to
- `--repo_owner`: The name of the GitHub repository owner
- `--repo_name`: The name of the repository
- `--github_token`: The token to get access to the repo
- `--actions`: The actions to do in the pipeline

If you provide the `--config` argument, the other options are not mandatory.

**Config File:**
This file is a YAML file containing the following information:

- `event`: A `string` with three available values: `commit`, `pull request`, or `*` for all possibilities.
- `repo_owner`: A `string` representing the GitHub repository owner's name.
- `repo_name`: A `string` representing the name of the repository.
- `github_token`: A `string` representing the token to access the repo.
- `actions`: A `string` encoded from a YAML file corresponding to the list of actions triggered by the pipeline.

An action is defined by the following template :

```yaml
actions:
  postinstall:
    configuration:
      container: debian:latest
    commands:
      - apt update
      - apt install mfa-postinstall
  build:
    configuration:
      container: dind:latest
    commands:
      - docker run debian:latest
```

Here is an example of a config file :

```yaml
event: ["commit", "pull request"]
repo_owner: "octocat"
repo_name: "Hello-World"
github_token: "your_github_token"
actions:
  postinstall:
    configuration:
      container: "ubuntu:latest"
    commands:
      - "apt-get update"
      - "apt-get install -y build-essential"
  build:
    configuration:
      container: "rust:latest"
    commands:
      - "cargo build --release"
```

**Recognize and Handle Events:**
Implement logic to recognize different types of events (starting with pull requests) and take appropriate actions based on the event type. It will need to parse the pipeline informations to create an actions file which will be given to the controller.

**Send Data to the Controller:**
Based on the recognized event and the actions file, send a request to the controller with the correct payload (body).
